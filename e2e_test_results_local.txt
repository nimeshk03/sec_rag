==========================================
End-to-End Testing: RAG Safety Checker
==========================================
API URL: http://localhost:8000
==========================================

==========================================
SECTION 1: Basic API Functionality
==========================================

[0;34mTest 1: Health endpoint returns status[0m
[0;32mâœ“ PASSED[0m
{"status":"healthy","timestamp":"2026-01-01T08:45:46.676845","dependencies":{"database":"connected","embedder":"loaded","retriever":"ready"},"version":"1.0.0"}

[0;34mTest 2: Root endpoint returns API name[0m
[0;32mâœ“ PASSED[0m
{"name":"SEC Filing RAG Safety System","version":"1.0.0","status":"running","docs":"/docs","health":"/health"}

[0;34mTest 3: API documentation is accessible[0m
[0;32mâœ“ PASSED[0m

    <!DOCTYPE html>
    <html>
    <head>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css">

==========================================
SECTION 2: Safety Check Workflows
==========================================

2.1: Testing PROCEED scenario (low allocation, no risk)
--------------------------------------------------------
[0;34mTest 4: Safety check with 5% allocation[0m
[0;32mâœ“ PASSED[0m
{"decision":"VETO","ticker":"AAPL","risk_score":7.0,"reasoning":"Critical event detected: Data retrieval failed - unable to assess risks","earnings_warning":"Upcoming earnings for AAPL in 10 day(s) on 2026-01-11","critical_events":["Data retrieval failed - unable to assess risks"],"allocation_warning":null,"cache_hit":false,"retrieved_chunks":[]}

2.2: Testing REDUCE scenario (medium allocation)
------------------------------------------------
[0;34mTest 5: Safety check with 15% allocation[0m
[0;32mâœ“ PASSED[0m
{"decision":"VETO","ticker":"AAPL","risk_score":7.0,"reasoning":"Critical event detected: Data retrieval failed - unable to assess risks","earnings_warning":"Upcoming earnings for AAPL in 10 day(s) on 2026-01-11","critical_events":["Data retrieval failed - unable to assess risks"],"allocation_warning":null,"cache_hit":false,"retrieved_chunks":[]}

2.3: Testing VETO scenario (high allocation)
--------------------------------------------
[0;34mTest 6: Safety check with 30% allocation[0m
[0;32mâœ“ PASSED[0m
{"decision":"VETO","ticker":"AAPL","risk_score":7.0,"reasoning":"Critical event detected: Data retrieval failed - unable to assess risks","earnings_warning":"Upcoming earnings for AAPL in 10 day(s) on 2026-01-11","critical_events":["Data retrieval failed - unable to assess risks"],"allocation_warning":null,"cache_hit":false,"retrieved_chunks":[]}

==========================================
SECTION 3: Edge Cases
==========================================

3.1: Invalid inputs
-------------------
[0;34mTest 7: Negative allocation rejected[0m
[0;31mâœ— FAILED[0m
Expected pattern: 422
Got: {"detail":[{"type":"greater_than_equal","loc":["body","allocation_pct"],"msg":"Input should be greater than or equal to 0","input":-5.0,"ctx":{"ge":0.0},"url":"https://errors.pydantic.dev/2.5/v/greater_than_equal"}]}

[0;34mTest 8: Allocation >100% rejected[0m
[0;31mâœ— FAILED[0m
Expected pattern: 422
Got: {"detail":[{"type":"less_than_equal","loc":["body","allocation_pct"],"msg":"Input should be less than or equal to 100","input":150.0,"ctx":{"le":100.0},"url":"https://errors.pydantic.dev/2.5/v/less_than_equal"}]}

[0;34mTest 9: Invalid ticker format rejected[0m
[0;31mâœ— FAILED[0m
Expected pattern: 422
Got: {"decision":"VETO","ticker":"INVALID123","risk_score":7.0,"reasoning":"Critical event detected: Data retrieval failed - unable to assess risks","earnings_warning":null,"critical_events":["Data retrieval failed - unable to assess risks"],"allocation_warning":null,"cache_hit":false,"retrieved_chunks":[]}

3.2: Zero allocation edge case
------------------------------
[0;34mTest 10: Zero allocation accepted[0m
[0;31mâœ— FAILED[0m
Expected pattern: PROCEED
Got: {"decision":"VETO","ticker":"AAPL","risk_score":7.0,"reasoning":"Critical event detected: Data retrieval failed - unable to assess risks","earnings_warning":"Upcoming earnings for AAPL in 10 day(s) on 2026-01-11","critical_events":["Data retrieval failed - unable to assess risks"],"allocation_warning":null,"cache_hit":false,"retrieved_chunks":[]}

3.3: Case insensitivity
----------------------
[0;34mTest 11: Lowercase ticker converted to uppercase[0m
[0;32mâœ“ PASSED[0m
{"decision":"VETO","ticker":"AAPL","risk_score":7.0,"reasoning":"Critical event detected: Data retrieval failed - unable to assess risks","earnings_warning":"Upcoming earnings for AAPL in 10 day(s) on 2026-01-11","critical_events":["Data retrieval failed - unable to assess risks"],"allocation_warning":null,"cache_hit":false,"retrieved_chunks":[]}

==========================================
SECTION 4: Cache Behavior
==========================================

4.1: Cache miss on first request
--------------------------------
[0;32mâœ“ PASSED[0m - First request is cache miss

4.2: Cache hit on subsequent request
------------------------------------
[0;31mâœ— FAILED[0m - Expected cache_hit:true

4.3: Cache invalidation
----------------------
[0;32mâœ“ PASSED[0m - Cache invalidated successfully

4.4: Cache stats tracking
------------------------
[0;34mTest 15: Cache stats endpoint returns metrics[0m
[0;32mâœ“ PASSED[0m
{"total_entries":0,"hit_rate":0.0,"total_hits":0,"total_misses":0,"avg_ttl_hours":12.0,"cache_size_mb":0.0}

==========================================
SECTION 5: Multiple Tickers
==========================================

Testing safety checks for multiple tickers...
[0;32mâœ“[0m AAPL: VETO
[0;32mâœ“[0m MSFT: VETO
[0;32mâœ“[0m GOOGL: VETO
[0;32mâœ“[0m TSLA: VETO
[0;32mâœ“[0m AMZN: VETO

==========================================
SECTION 6: Allocation Buckets
==========================================

Testing different allocation percentages...
[0;32mâœ“[0m 1%: VETO (risk: 7.0)
[0;32mâœ“[0m 5%: VETO (risk: 7.0)
[0;32mâœ“[0m 10%: VETO (risk: 7.0)
[0;32mâœ“[0m 15%: VETO (risk: 7.0)
[0;32mâœ“[0m 20%: VETO (risk: 7.0)
[0;32mâœ“[0m 25%: VETO (risk: 7.0)
[0;32mâœ“[0m 30%: VETO (risk: 7.0)

==========================================
SECTION 7: Response Structure Validation
==========================================

Validating safety check response structure...
[0;32mâœ“[0m Field 'decision' present
[0;32mâœ“[0m Field 'ticker' present
[0;32mâœ“[0m Field 'risk_score' present
[0;32mâœ“[0m Field 'reasoning' present
[0;32mâœ“[0m Field 'cache_hit' present

==========================================
SECTION 8: Error Handling
==========================================

8.1: Missing required fields
---------------------------
[0;34mTest 33: Missing ticker field[0m
[0;31mâœ— FAILED[0m
Expected pattern: 422
Got: {"detail":[{"type":"missing","loc":["body","ticker"],"msg":"Field required","input":{"allocation_pct":10.0},"url":"https://errors.pydantic.dev/2.5/v/missing"}]}

[0;34mTest 34: Missing allocation field[0m
[0;31mâœ— FAILED[0m
Expected pattern: 422
Got: {"detail":[{"type":"missing","loc":["body","allocation_pct"],"msg":"Field required","input":{"ticker":"AAPL"},"url":"https://errors.pydantic.dev/2.5/v/missing"}]}

8.2: Invalid JSON
----------------
[0;34mTest 35: Malformed JSON rejected[0m
[0;31mâœ— FAILED[0m
Expected pattern: 422
Got: {"detail":[{"type":"json_invalid","loc":["body",1],"msg":"JSON decode error","input":{},"ctx":{"error":"Expecting property name enclosed in double quotes"}}]}

==========================================
SECTION 9: Concurrent Requests
==========================================

Testing concurrent safety checks...
[0;32mâœ“ PASSED[0m - Handled 5 concurrent requests

==========================================
SECTION 10: System Health
==========================================

Checking system dependencies...
[0;32mâœ“[0m database: connected
[0;32mâœ“[0m retriever: ready

==========================================
TEST SUMMARY
==========================================

Total Tests: 38
[0;32mPassed: 30[0m
[0;31mFailed: 8[0m

[0;31m==========================================
SOME TESTS FAILED
==========================================\033[0m
